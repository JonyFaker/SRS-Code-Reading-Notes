# HLS切片设计

**传统HLS直播做法**

熟悉HLS直播的同学都知道hls直播其实是http下载ts文件实现的伪直播，传统做法是开启一个TS文件切片任务，实时生成TS文件和m3u8文件，同时开启http下载服务。

**这种做法存在两个问题：**

1. 以整数倍个gop切片，如果gop不均匀则会导致切出来的ts文件大小不一，影响客户端缓存和播放，进而导致卡顿甚至停播。
2. 严格按照时间切片，虽然切出来的ts文件时长稳定，但是会造成很多ts文件不是以I帧开始，中途来观看的观众下载到的第一个甚至连续几个ts文件中都没有I帧，影响首屏时间。另外虽然没有i帧播放器处于黑屏状态，但是音频帧却是可以正常播放的，所以有可能导致开始有声音却黑屏的现象，影响观看体验。

**新思路的设计**

针对以上两个问题，我们可以设想，如果播放器每次播放的时候服务器都可以识别到是不是第一次http请求，如果是的话就从I帧开始打包ts文件，然后发送给播放器，这样就可以解决上面出现的问题。

为了实现这个思路，我们需要明确三个目标：

第一、给hls播放添加状态，由于http是无状态的，播放器发送http请求的时候服务器无法判是不是同一个播放器发出的，也无法判断是不是第一次发送http请求。至于如果给hls加状态请参考以前的博文（**++==easydss系统HLS客户端在线数量统计原理==++**）。

第二、hls有了状态之后意味着我们可以在服务端需要维护每路hls播放的进度，换句话说虽然大家在观看同一路直播，但是不同播放器下载到的m3u8内容有可能是不一样的，因为每个播放器开始播放的时间点不一样，对播放器来说看到的第一个I帧也是不一样的，虽然是同一路流，打包的进度不一样。

第三、代码实现上需要注意，虽然每路hls播放都对应着一个m3u8和ts打包任务，并不代表ts数据不能共享，我们可以先将ts数据打包好并且缓存在一个buffer中，每路hls播放对应的打包任务只需记录下“虚拟TS文件”的内容在buffer中的位置即可。每路打包进度虽然不同，但是公用同一个ts流buffer，通过标记内存指针的方式实现ts流共享。

目前本人已经测试并且实现了以上流程，不仅可以控制到每个播放客户端的播放进度还可以通过上述方法统计观看人数，流量计费等等功能。有时间会公布部分实现逻辑，欢迎继续关注。

原文地址：https://my.oschina.net/cczjp89/blog/1541414